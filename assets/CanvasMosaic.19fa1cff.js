import{d as e,r as t,g as s,h as n,i as o,Z as a,j as i,o as l,c,b as d,k as u,F as h,f as r}from"./index.90d98501.js";class m{constructor(e,t={}){this.originalImgData=null,this.downPoint=null,this.points=[],this.ops=[],this.inited=!1,this.mosaicSize=3,this.brushWidth=40,Object.assign(this,t),this.canvas=e,this.ctx=e.getContext("2d"),this.mouseDownHandler=this.mouseDownHandler.bind(this),this.documentMouseMoveHandle=this.documentMouseMoveHandle.bind(this),this.documentMouseUpHandle=this.documentMouseUpHandle.bind(this),e.addEventListener("mousedown",this.mouseDownHandler)}async init(e){await v(this.canvas,e);const{width:t,height:s}=this.canvas;this.originalImgData=this.ctx.getImageData(0,0,t,s),this.inited=!0}destroy(){this.canvas.onmousedown=null,this.canvas.removeEventListener("mousedown",this.mouseDownHandler)}mouseDownHandler(e){e.stopImmediatePropagation(),document.onselectstart=()=>!1;const{pageX:t,pageY:s}=e,{offsetLeft:n,offsetTop:o}=this.canvas,{scrollLeft:a,scrollTop:i}=this.canvas.parentElement;console.log(t,n,a,s,o,i),this.downPoint=[t-n+a,s-o+i],console.log(this.downPoint),this.points=[],document.addEventListener("mousemove",this.documentMouseMoveHandle),document.addEventListener("mouseup",this.documentMouseUpHandle)}documentMouseMoveHandle(e){if(!this.downPoint)return;e.stopImmediatePropagation();const{pageX:t,pageY:s}=e,{offsetLeft:n,offsetTop:o}=this.canvas,{scrollLeft:a,scrollTop:i}=this.canvas.parentElement,l=[t-n+a,s-o+i];this.dealMosaicXY(l)}documentMouseUpHandle(e){this.downPoint=null,document.removeEventListener("mousemove",this.documentMouseMoveHandle),document.removeEventListener("mouseup",this.documentMouseUpHandle),document.onselectstart=null,this.points=[]}dealMosaicXY(e){const t=this.brushWidth-~~(this.brushWidth/this.mosaicSize/2)*this.mosaicSize*2;let[s,n]=e;s=+Math.round((s-t)/this.mosaicSize/2)*this.mosaicSize*2,n=+Math.round((n-t)/this.mosaicSize/2)*this.mosaicSize*2,e=[s,n];const o=this.points.slice(-1)[0];o&&o[0]===s&&o[1]===n||-1===this.points.findIndex((e=>e[0]===s&&e[1]===n))&&(this.points.push(e),this.drawMosaic(e))}drawMosaic(e){const{mosaicSize:t,brushWidth:s}=this,n=~~(s/t/2),o=s-n*t*2,{width:a,height:i}=this.canvas,l=this.originalImgData.data,c=this.ctx.getImageData(0,0,a,i);let d=c.data;const[u,h]=e;for(var r=u-t*n,m=u+t*n+o;r<m;r+=2*t)for(var v=h-t*n,p=h+t*n+o;v<p;v+=2*t){let[e,n,i]=[0,0,0],c=[];for(let d=r,w=r+2*t;d<w;d++)for(let r=v,m=v+2*t;r<m;r++){const t=4*(r*a+d);(r-h+o/2)**2+(d-u+o/2)**2<=(s/2)**2&&c.push(t),e+=l[t],n+=l[t+1],i+=l[t+2]}const m=(2*t)**2,[p,g,f]=[e/m,n/m,i/m];for(let t=0;t<c.length;t++){const e=c[t];d[e]=p,d[e+1]=g,d[e+2]=f}}this.ctx.putImageData(c,0,0,0,0,a,i)}}const v=(e,t)=>new Promise(((s,n)=>{const o=URL.createObjectURL(t),a=new Image;a.onload=()=>{const{naturalWidth:t,naturalHeight:n}=a,i=e.getContext("2d");Object.assign(e,{width:t,height:n}),i.drawImage(a,0,0,t,n),URL.revokeObjectURL(o),s(e)},a.onerror=e=>{n(e),URL.revokeObjectURL(o)},a.src=o}));var p=e({name:"CanavsMosaic",setup(){const e=t(30),i=t(6),l=t(null),c=t(null);return s((()=>{const t=Object.create(null);t.brushWidth=e.value,t.mosaicSize=i.value,c.value=new m(l.value,t)})),n((()=>{c.value&&c.value.destroy()})),o(e,(e=>{c.value&&(c.value.brushWidth=e)})),{mosaicSizeChange:function(e){c.value&&(c.value.mosaicSize=e)},openFile:function(){new Promise(((e,t)=>{const s=document.createElement("input");s.type="file",s.accept="image/*",s.onchange=()=>{const{files:n}=s;(!n||n.length<=0)&&t();const o=Array.from(n)[0];o.type.startsWith("image/")?e(o):t()},s.click()})).then((e=>{var t;null==(t=c.value)||t.init(e)}))},downloadImage:function(){var e;(null==(e=c.value)?void 0:e.inited)?((e=>{const t=e.toDataURL("image/png"),s=document.createElement("a");s.download=`导出图片${Date.now()}.png`,s.href=t,s.click()})(l.value),a.info("文件已开始下载")):a.info("请选择图片")},mosaicSize:i,brushWidth:e,canvasRef:l}}});const g=r("选择图片"),f=r("下载图片"),w={class:"canvas-wrapper"},b={ref:"canvasRef",width:"400",height:"400"};p.render=function(e,t,s,n,o,a){const r=i("el-input-number"),m=i("el-form-item"),v=i("el-button"),p=i("el-form");return l(),c(h,null,[d(p,{inline:!0,size:"mini"},{default:u((()=>[d(m,{label:"马赛克大小"},{default:u((()=>[d(r,{modelValue:e.mosaicSize,"onUpdate:modelValue":t[1]||(t[1]=t=>e.mosaicSize=t),onChange:e.mosaicSizeChange,min:4,max:8},null,8,["modelValue","onChange"])])),_:1}),d(m,{label:"笔刷宽度"},{default:u((()=>[d(r,{modelValue:e.brushWidth,"onUpdate:modelValue":t[2]||(t[2]=t=>e.brushWidth=t),min:30,step:10,max:100},null,8,["modelValue"])])),_:1}),d(m,null,{default:u((()=>[d(v,{type:"primary",onClick:e.openFile},{default:u((()=>[g])),_:1},8,["onClick"]),d(v,{type:"primary",onClick:e.downloadImage},{default:u((()=>[f])),_:1},8,["onClick"])])),_:1})])),_:1}),d("div",w,[d("canvas",b,null,512)])],64)};export default p;
